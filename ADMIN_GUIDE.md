# 管理者ガイド：組織認証申請の承認方法

## 📋 目次
1. [管理者アカウントの設定](#管理者アカウントの設定)
2. [管理者ダッシュボードへのアクセス](#管理者ダッシュボードへのアクセス)
3. [認証申請の承認手順](#認証申請の承認手順)
4. [よくある質問](#よくある質問)

---

## 🔐 管理者アカウントの設定

### ステップ1: Supabaseダッシュボードにアクセス
1. [Supabaseダッシュボード](https://app.supabase.com)にログイン
2. プロジェクトを選択

### ステップ2: SQL Editorを開く
1. 左サイドバーの「SQL Editor」をクリック
2. 「New query」をクリック

### ステップ3: 管理者権限を設定
以下のSQLを実行して、自分のアカウントを管理者に設定します：

```sql
-- メールアドレスで指定する場合（推奨）
UPDATE profiles
SET is_admin = true
WHERE email = 'your-email@example.com';
```

**重要**: `your-email@example.com` を実際のメールアドレスに置き換えてください。

### ステップ4: 設定の確認
管理者権限が正しく設定されたか確認します：

```sql
SELECT id, email, name, is_admin, account_type
FROM profiles
WHERE email = 'your-email@example.com';
```

`is_admin` が `true` になっていれば成功です。

---

## 🎯 管理者ダッシュボードへのアクセス

### ステップ1: ログアウトして再ログイン
管理者権限を設定した後は、**一度ログアウトして再ログイン**してください。
これにより、認証コンテキストが更新されます。

### ステップ2: 管理者ダッシュボードにアクセス
1. ブラウザで `/admin` にアクセス
   - 例: `http://localhost:3000/admin`
2. 管理者権限がある場合、ダッシュボードが表示されます
3. 管理者権限がない場合、ホームページにリダイレクトされます

---

## ✅ 認証申請の承認手順

### ステップ1: 認証申請タブを開く
1. 管理者ダッシュボード（`/admin`）にアクセス
2. 上部のタブから「**認証申請**」をクリック
3. 認証待ちの申請一覧が表示されます

### ステップ2: 申請の詳細を確認
1. 承認したい申請の「**詳細**」ボタンをクリック
2. モーダルが開き、以下の情報が表示されます：
   - 組織名
   - 申請者情報（名前・メールアドレス）
   - 担当者情報（名前・メールアドレス）
   - 組織URL（あれば）
   - 申請理由（あれば）
   - 申請日

### ステップ3: 審査メモを記入（任意）
1. モーダル下部の「審査メモ」テキストエリアに、必要に応じてメモを記入
2. このメモは内部記録として保存されます

### ステップ4: 承認または拒否
#### 承認する場合
1. 「**承認**」ボタンをクリック
2. 確認ダイアログが表示されたら「OK」をクリック
3. 申請が承認され、以下の処理が自動的に実行されます：
   - `organization_verification_requests` テーブルの `status` が `'approved'` に更新
   - `profiles` テーブルの `verification_status` が `'verified'` に更新
   - 申請者は組織用機能（コミュニティ作成など）を使用できるようになります

#### 拒否する場合
1. 「**拒否**」ボタンをクリック
2. 確認ダイアログが表示されたら「OK」をクリック
3. 申請が拒否され、以下の処理が自動的に実行されます：
   - `organization_verification_requests` テーブルの `status` が `'rejected'` に更新
   - `profiles` テーブルの `verification_status` が `'rejected'` に更新
   - 申請者は再申請することができます

### ステップ5: 結果の確認
- 承認/拒否後、申請一覧から該当の申請が消えます（`pending` ステータスのみ表示されるため）
- 申請者のプロフィールページで、認証状態が更新されていることを確認できます

---

## 📊 統計情報の確認

管理者ダッシュボードの「統計情報」タブでは、以下の情報を確認できます：

- **総ユーザー数**: 登録されている全ユーザー数
- **組織アカウント**: 教育機関・企業・政府機関のアカウント数
- **認証待ち**: 承認待ちの認証申請数
- **通報待ち**: 処理待ちの通報数
- **総投稿数**: 全投稿数
- **公式投稿**: 組織アカウントによる公式投稿数
- **総コメント数**: 全コメント数

---

## 👥 ユーザー管理

管理者ダッシュボードの「ユーザー管理」タブでは、以下の操作が可能です：

### ユーザー検索・フィルター
- アカウントタイプ（個人・教育機関・企業・政府機関）でフィルター
- 認証ステータス（未認証・審査中・認証済み・拒否）でフィルター
- アカウント状態（有効・停止中）でフィルター
- 名前・メール・組織名で検索

### 認証状態の直接変更
組織アカウントの場合、認証状態を直接変更できます：
1. ユーザー一覧から対象ユーザーを探す
2. 認証状態のドロップダウンから新しい状態を選択
3. 確認ダイアログで「OK」をクリック

---

## ❓ よくある質問

### Q1: 管理者権限を設定したのに、ダッシュボードにアクセスできません
**A**: 以下の点を確認してください：
1. 一度ログアウトして再ログインしているか
2. SQLで `is_admin = true` が正しく設定されているか（確認SQLを実行）
3. ブラウザのキャッシュをクリアして再試行

### Q2: 認証申請が表示されません
**A**: 以下の点を確認してください：
1. 申請が `pending` ステータスになっているか
2. `organization_verification_requests` テーブルにデータが存在するか
3. ブラウザをリロードして再試行

### Q3: 承認/拒否ボタンが動作しません
**A**: 以下の点を確認してください：
1. ブラウザのコンソール（F12）でエラーを確認
2. ネットワーク接続を確認
3. SupabaseのRLSポリシーが正しく設定されているか確認

### Q4: 複数の管理者を設定できますか？
**A**: はい、複数のユーザーを管理者に設定できます。以下のSQLで複数のユーザーを一度に設定できます：

```sql
UPDATE profiles
SET is_admin = true
WHERE email IN ('admin1@example.com', 'admin2@example.com', 'admin3@example.com');
```

### Q5: 管理者権限を削除するには？
**A**: 以下のSQLで管理者権限を削除できます：

```sql
UPDATE profiles
SET is_admin = false
WHERE email = 'your-email@example.com';
```

---

## 🔒 セキュリティに関する注意事項

1. **管理者権限の管理**: 管理者権限を持つアカウントは慎重に管理してください
2. **パスワード**: 管理者アカウントには強力なパスワードを設定してください
3. **ログ**: 承認/拒否の操作は `organization_verification_requests` テーブルの `reviewed_by` と `reviewed_at` に記録されます
4. **RLSポリシー**: 管理者権限に関連するRLSポリシーが正しく設定されているか確認してください

---

## 📝 関連ファイル

- `src/app/admin/page.tsx`: 管理者ダッシュボードのUI
- `src/lib/admin.ts`: 管理者機能の実装
- `setup-admin-account.sql`: 管理者アカウント設定用SQL

---

## 🆘 サポート

問題が発生した場合：
1. ブラウザのコンソール（F12）でエラーを確認
2. Supabaseダッシュボードのログを確認
3. データベースのRLSポリシーを確認





