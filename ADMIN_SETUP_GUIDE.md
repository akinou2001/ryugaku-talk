# Supabaseアカウント管理機能セットアップガイド

## 📋 概要

Supabaseを使用したアカウント管理機能を実装しました。管理者は組織アカウントの認証、ユーザー管理、統計情報の確認ができます。

## 🚀 セットアップ手順

### 1. データベーススキーマの適用

SupabaseダッシュボードのSQLエディタで以下を実行：

```sql
-- supabase-schema-admin.sql を実行
```

これにより以下が追加されます：
- `profiles`テーブルに管理者・アカウント管理用カラム
- 管理者用RLSポリシー
- 統計情報ビュー

### 2. 最初の管理者アカウントを作成

#### 方法1: Supabaseダッシュボードから直接設定

1. Supabaseダッシュボード → 「Table Editor」→ `profiles`テーブル
2. 管理者にしたいユーザーの行を選択
3. `is_admin`カラムを`true`に設定
4. 保存

#### 方法2: SQLで設定

```sql
-- 特定のユーザーを管理者にする（emailで指定）
UPDATE profiles 
SET is_admin = TRUE 
WHERE email = 'admin@example.com';
```

#### 方法3: 新規ユーザーを管理者として作成

1. 通常通りアカウントを作成
2. 上記の方法1または2で管理者権限を付与

### 3. 環境変数の確認

`.env.local`に以下が設定されていることを確認：

```env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

## 🎯 機能

### 管理者ダッシュボード (`/admin`)

#### 1. 統計情報
- 総ユーザー数
- 組織アカウント数
- 認証待ちの申請数
- 通報待ちの件数
- 投稿・コメント数

#### 2. 認証申請管理
- 組織アカウントの認証申請一覧
- 申請の詳細確認
- 承認・拒否処理
- 審査メモの記録

#### 3. ユーザー管理
- ユーザー一覧・検索
- アカウントタイプでフィルタリング
- 認証ステータスでフィルタリング
- アカウント状態でフィルタリング
- ユーザーの停止・復帰（今後実装予定）

## 🔒 セキュリティ

### RLSポリシー

以下のRLSポリシーが設定されています：

1. **管理者は全ユーザーのプロフィールを閲覧可能**
2. **管理者は全ユーザーのプロフィールを更新可能**
3. **管理者は認証ステータスを更新可能**
4. **管理者は認証申請を閲覧・更新可能**
5. **管理者は投稿・コメントを削除可能**
6. **管理者は通報を閲覧・更新可能**

### アクセス制御

- 管理者ダッシュボードは管理者のみアクセス可能
- 非管理者がアクセスしようとすると自動的にリダイレクト

## 📝 使用方法

### 組織アカウントの認証

1. `/admin`にアクセス
2. 「認証申請」タブを開く
3. 承認したい申請を選択
4. 「詳細」ボタンをクリック
5. 審査メモを入力（任意）
6. 「承認」または「拒否」をクリック

### ユーザー検索

1. `/admin`にアクセス
2. 「ユーザー管理」タブを開く
3. フィルターを設定
4. 「検索」ボタンをクリック

## 🛠️ 実装ファイル

- `supabase-schema-admin.sql` - データベーススキーマ
- `src/lib/admin.ts` - 管理者機能のヘルパー関数
- `src/app/admin/page.tsx` - 管理者ダッシュボード
- `src/components/Header.tsx` - 管理者メニューの追加

## 🔧 トラブルシューティング

### 管理者ダッシュボードにアクセスできない

1. `is_admin`が`true`に設定されているか確認
2. ブラウザのキャッシュをクリア
3. ログアウトして再ログイン

### 認証申請が表示されない

1. `organization_verification_requests`テーブルが存在するか確認
2. 申請のステータスが`pending`か確認

### 統計情報が表示されない

1. `admin_stats`ビューが作成されているか確認
2. ビューが存在しない場合は、個別に統計を取得する機能が自動的に動作します

## 📊 今後の拡張

- [ ] ユーザーの停止・復帰機能のUI実装
- [ ] 投稿・コメントの削除機能
- [ ] 通報処理機能
- [ ] メール通知機能（認証完了時など）
- [ ] 管理者ログの記録

