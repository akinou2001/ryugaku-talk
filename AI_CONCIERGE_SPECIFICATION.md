# AIコンシェルジュ機能 実装仕様書

## 📋 目次
1. [目的](#目的)
2. [要件](#要件)
3. [詳細設計](#詳細設計)
4. [API設計](#api設計)
5. [フロントエンド設計](#フロントエンド設計)
6. [データフロー](#データフロー)
7. [技術スタック](#技術スタック)

---

## 目的

### 1.1 機能の目的
AIコンシェルジュは、留学支援コミュニティ「RyugakuTalk」において、ユーザーの質問に対してAIが回答を提供する機能です。以下の目的を実現します：

- **質問回答の自動化**: ユーザーの質問に対して、過去の投稿や外部情報を参照しながら、AIが自動で回答を生成
- **情報の可視化**: 回答の根拠となる過去の投稿や外部情報を明示的に表示
- **ユーザー推薦**: 質問内容に関連する経験を持つユーザーを推薦し、コミュニティ内のつながりを促進
- **信頼性の確保**: 参照がある場合とない場合を明確に区別し、ハルシネーションを防止

### 1.2 ビジネス価値
- ユーザーの質問に対する即座の回答提供により、ユーザーエンゲージメントを向上
- 過去の投稿を活用することで、コミュニティの知識資産を最大限に活用
- ユーザー推薦により、コミュニティ内の交流を促進

---

## 要件

### 2.1 機能要件

#### 2.1.1 質問回答機能
- **必須**: ユーザーが質問を入力し、AIが回答を生成
- **必須**: 回答は日本語で、わかりやすく、親切に記述
- **必須**: 過去の投稿を参照する場合は、投稿のタイトルや投稿者名を明記
- **必須**: 外部情報を参照する場合は、出典を明記

#### 2.1.2 参照モード
- **必須**: 参照あり（grounded）モード: 過去の投稿や外部情報を根拠として回答
- **必須**: 参照なし（reasoning）モード: 一般的な推論に基づく回答（不確実性を明示）

#### 2.1.3 関連情報の表示
- **必須**: 参考になる過去の投稿を表示（最大5件）
- **必須**: おすすめユーザーを表示（最大3件）
- **必須**: 引用元情報を表示
- **必須**: 回答の信頼度を表示（high/medium/low）

#### 2.1.4 UI要件
- **必須**: レスポンシブデザイン（スマホ・タブレット・PC対応）
- **必須**: 複数行の質問入力に対応（textarea）
- **必須**: 文字数カウンター表示
- **必須**: キーボードショートカット（Ctrl+Enter / Cmd+Enter）で送信

### 2.2 非機能要件

#### 2.2.1 パフォーマンス
- 回答生成時間: 10秒以内（目標）
- 検索処理時間: 2秒以内（目標）

#### 2.2.2 セキュリティ
- OpenAI APIキーは環境変数で管理
- ユーザー入力のサニタイズ
- エラーハンドリングの適切な実装

#### 2.2.3 可用性
- OpenAI APIのエラーハンドリング（401, 429エラー対応）
- フォールバック処理の実装

---

## 詳細設計

### 3.1 アーキテクチャ概要

```
┌─────────────┐
│  フロントエンド  │
│  (React)    │
└──────┬──────┘
       │ HTTP POST
       ▼
┌─────────────────────────────────────┐
│  質問受付API (POST /api/ai)         │
│  - 質問を受け取り、全体フローを実行  │
└──────┬──────────────────────────────┘
       │
       ├─→ 関連投稿検索
       │   (findRelevantPostsForQuery)
       │
       ├─→ 類似ユーザー検索
       │   (findSimilarUsers)
       │
       ├─→ 外部情報取得（将来実装）
       │
       └─→ AI回答生成
           (OpenAI GPT-3.5-turbo)
```

### 3.2 処理フロー

1. **質問受付**: ユーザーが質問を入力し、送信
2. **関連投稿検索**: 質問に関連する過去の投稿を検索（最大5件）
3. **類似ユーザー検索**: 質問内容に近い経験を持つユーザーを検索（最大3件）
4. **外部情報取得**: 外部情報を取得（現時点では空配列）
5. **モード判定**: 参照があるかどうかでモードを決定
   - 参照あり → `grounded`モード
   - 参照なし → `reasoning`モード
6. **AI回答生成**: OpenAI APIを使用して回答を生成
7. **結果返却**: 回答、引用情報、関連投稿、おすすめユーザーを返却

### 3.3 モード分けの詳細

#### 3.3.1 Groundedモード（参照あり）
- **条件**: 関連投稿または外部情報が1件以上存在
- **プロンプト**: 提供された情報を根拠として回答
- **信頼度**: `high`
- **表示**: 「参照あり」バッジを表示

#### 3.3.2 Reasoningモード（参照なし）
- **条件**: 関連投稿も外部情報も存在しない
- **プロンプト**: 一般的な推論に基づく回答（不確実性を明示）
- **信頼度**: `low`
- **表示**: 「推論」バッジを表示

---

## API設計

### 4.1 質問受付API（起点）

**エンドポイント**: `POST /api/ai`

**リクエスト**:
```json
{
  "question_text": "イギリス留学のビザ申請について教えてください",
  "context": {
    "study_abroad_destination": "イギリス",
    "period": "2024年"
  }
}
```

**レスポンス**:
```json
{
  "answer_text": "イギリス留学のビザ申請について...",
  "citations": [
    {
      "type": "post",
      "ref_id": "post-uuid",
      "title": "イギリスビザ申請の体験談",
      "confidence_level": "high"
    }
  ],
  "related_posts": [
    {
      "post_id": "post-uuid",
      "title": "イギリスビザ申請の体験談",
      "content_snippet": "イギリス留学のビザ申請は...",
      "author_name": "山田太郎",
      "created_at": "2024-01-01T00:00:00Z",
      "likes_count": 10,
      "comments_count": 5,
      "category": "question"
    }
  ],
  "recommended_users": [
    {
      "user_id": "user-uuid",
      "display_name": "山田太郎",
      "attributes": {
        "study_abroad_destination": "イギリス",
        "university": "Oxford University",
        "major": "Economics"
      },
      "contribution_score": 150,
      "icon_url": "https://..."
    }
  ],
  "mode": "grounded",
  "confidence_level": "high"
}
```

### 4.2 関連投稿検索API

**エンドポイント**: `POST /api/posts/search`

**実装ファイル**: `src/app/api/posts/search/route.ts`

**機能**:
- 質問テキストからキーワードを抽出
- タイトルとコンテンツで全文検索
- いいね数、コメント数、作成日時でソート
- 最大5件を返却

**検索ロジック**:
1. キーワード抽出: 質問テキストを空白で分割し、2文字以上の単語を抽出（最大5つ）
2. 検索: 各キーワードでタイトルとコンテンツを部分一致検索（ILIKE）
3. ソート: いいね数 → コメント数 → 作成日時（降順）

### 4.3 類似ユーザー検索API

**エンドポイント**: `POST /api/users/recommend`

**実装ファイル**: `src/app/api/users/recommend/route.ts`

**機能**:
- 質問テキストからキーワードを抽出
- 留学先、大学、専攻、bioで検索
- 貢献度スコアでソート
- 最大3件を返却

**検索ロジック**:
1. キーワード抽出: 質問テキストを空白で分割し、2文字以上の単語を抽出（最大5つ）
2. 検索: 各キーワードで留学先、大学、専攻、bioを部分一致検索（ILIKE）
3. フィルタ: アクティブユーザーのみ（`is_active = true`）
4. ソート: 貢献度スコア（降順）

### 4.4 AI回答生成API

**エンドポイント**: `POST /api/ai/generate`

**実装ファイル**: `src/app/api/ai/generate/route.ts`

**機能**:
- 関連投稿と外部情報をコンテキストとして使用
- OpenAI GPT-3.5-turboで回答を生成
- 引用情報を整形

**プロンプト設計**:

**Groundedモード**:
```
システムプロンプト:
あなたは留学支援コミュニティ「RyugakuTalk」のAIコンシェルジュです。
ユーザーの質問に対して、提供された過去の投稿や外部情報を根拠として、親切で正確な回答を提供してください。

ユーザープロンプト:
以下の質問に回答してください。

質問: [質問テキスト]

参考になる過去の投稿:
[投稿1]
タイトル: ...
投稿者: ...
内容: ...

上記の情報を根拠として、質問に回答してください。
```

**Reasoningモード**:
```
システムプロンプト:
あなたは留学支援コミュニティ「RyugakuTalk」のAIコンシェルジュです。
ユーザーの質問に対して、一般的な留学経験・制度・合理的推論に基づいて回答してください。

ユーザープロンプト:
以下の質問に回答してください。

質問: [質問テキスト]

一般的な留学経験・制度・合理的推論に基づいて回答してください。
これは推論に基づく回答であることを明記してください。
```

**パラメータ**:
- `model`: `gpt-3.5-turbo`
- `temperature`: `0.7`
- `max_tokens`: `1500`

---

## フロントエンド設計

### 5.1 ページ構成

**ファイル**: `src/app/ai/page.tsx`

**主要コンポーネント**:
1. **入力エリア**: 質問入力用のtextarea
2. **回答エリア**: AIからの回答を表示
3. **引用情報セクション**: 引用元を表示
4. **おすすめユーザーセクション**: 関連ユーザーを表示
5. **参考投稿セクション**: 関連投稿を表示

### 5.2 UI要素

#### 5.2.1 入力エリア
- **textarea**: 複数行入力対応
  - 初期行数: 4行
  - 最小高さ: 100px（スマホ）/ 120px（タブレット以上）
  - 最大高さ: 300px
  - リサイズ可能（縦方向のみ）
- **文字数カウンター**: リアルタイム表示
- **送信ボタン**: クリックまたはCtrl+Enter / Cmd+Enterで送信

#### 5.2.2 回答エリア
- **回答テキスト**: 改行を保持して表示（`whitespace-pre-wrap`）
- **モードバッジ**: 
  - `grounded` → 「参照あり」（緑）
  - `reasoning` → 「推論」（黄）
- **信頼度バッジ**: `high`の場合のみ「信頼度高」（青）を表示

#### 5.2.3 引用情報セクション
- 引用元のリストを表示
- タイプ（投稿/外部情報）を表示
- 各引用元に番号を付与

#### 5.2.4 おすすめユーザーセクション
- ユーザーカード形式で表示
- アバター、名前、属性（留学先、大学）、貢献度スコアを表示
- プロフィールページへのリンク

#### 5.2.5 参考投稿セクション
- 投稿カード形式で表示
- タイトル、内容スニペット、投稿者、いいね数、コメント数を表示
- 投稿詳細ページへのリンク

### 5.3 レスポンシブデザイン

- **スマホ**: 縦並びレイアウト、小さいフォントサイズ、コンパクトなパディング
- **タブレット**: 中サイズのフォント、適度なパディング
- **PC**: 大サイズのフォント、余裕のあるパディング

---

## データフロー

### 6.1 質問回答フロー

```
1. ユーザー入力
   ↓
2. POST /api/ai
   ↓
3. 関連投稿検索 (findRelevantPostsForQuery)
   ↓
4. 類似ユーザー検索 (findSimilarUsers)
   ↓
5. モード判定
   ├─ 参照あり → grounded
   └─ 参照なし → reasoning
   ↓
6. AI回答生成 (OpenAI API)
   ↓
7. 結果整形
   ├─ 回答テキスト
   ├─ 引用情報
   ├─ 関連投稿
   ├─ おすすめユーザー
   ├─ モード
   └─ 信頼度
   ↓
8. フロントエンド表示
```

### 6.2 検索フロー

#### 6.2.1 関連投稿検索
```
質問テキスト
  ↓
キーワード抽出（2文字以上の単語、最大5つ）
  ↓
Supabase検索（タイトル・コンテンツで部分一致）
  ↓
ソート（いいね数 → コメント数 → 作成日時）
  ↓
最大5件を返却
```

#### 6.2.2 類似ユーザー検索
```
質問テキスト
  ↓
キーワード抽出（2文字以上の単語、最大5つ）
  ↓
Supabase検索（留学先・大学・専攻・bioで部分一致）
  ↓
フィルタ（アクティブユーザーのみ）
  ↓
ソート（貢献度スコア）
  ↓
最大3件を返却
```

---

## 技術スタック

### 7.1 フロントエンド
- **フレームワーク**: Next.js 14 (App Router)
- **言語**: TypeScript
- **UIライブラリ**: Tailwind CSS
- **アイコン**: Lucide React

### 7.2 バックエンド
- **API**: Next.js API Routes
- **データベース**: Supabase (PostgreSQL)
- **検索**: Supabaseの全文検索（ILIKE）

### 7.3 AI/LLM
- **モデル**: OpenAI GPT-3.5-turbo
- **SDK**: OpenAI Node.js SDK
- **設定**:
  - Temperature: 0.7
  - Max Tokens: 1500

### 7.4 環境変数
```env
OPENAI_API_KEY=your_openai_api_key
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

---

## 実装ファイル一覧

### 8.1 API
- `src/app/api/ai/route.ts` - 質問受付API（起点）
- `src/app/api/ai/generate/route.ts` - AI回答生成API
- `src/app/api/posts/search/route.ts` - 関連投稿検索API
- `src/app/api/users/recommend/route.ts` - 類似ユーザー検索API

### 8.2 ライブラリ
- `src/lib/searchPosts.ts` - 投稿検索関数
- `src/lib/searchUsers.ts` - ユーザー検索関数

### 8.3 フロントエンド
- `src/app/ai/page.tsx` - AIコンシェルジュページ

### 8.4 コンポーネント
- `src/components/AIConciergeButton.tsx` - AIコンシェルジュボタン

---

## 今後の拡張予定

### 9.1 外部情報取得機能
- 公式サイト、教育機関の情報を取得
- Wikipedia、留学支援機関の情報を取得
- APIエンドポイント: `GET /api/external/search`

### 9.2 回答履歴機能
- ユーザーの質問履歴を保存
- 過去の回答を参照可能に

### 9.3 評価機能
- 回答の有用性を評価
- フィードバックを収集して改善

### 9.4 埋め込みベクトル検索
- より精度の高い投稿検索
- セマンティック検索の実装

---

## エラーハンドリング

### 10.1 APIエラー
- **401エラー**: OpenAI APIキーが無効
- **429エラー**: API利用制限に達した
- **500エラー**: その他のエラー

### 10.2 フロントエンドエラー
- エラーメッセージを赤いバナーで表示
- ユーザーに分かりやすいエラーメッセージを提供

---

## セキュリティ考慮事項

### 11.1 APIキー管理
- OpenAI APIキーは環境変数で管理
- クライアントサイドに露出しない

### 11.2 入力検証
- 質問テキストの空チェック
- 文字数制限（実装予定）

### 11.3 レート制限
- OpenAI APIのレート制限に対応
- 429エラー時の適切な処理

---

## パフォーマンス最適化

### 12.1 検索最適化
- インデックスの活用（Supabase）
- 検索結果のキャッシュ（将来実装）

### 12.2 AI回答生成
- トークン数の最適化
- プロンプトの効率化

---

## まとめ

AIコンシェルジュ機能は、過去の投稿や外部情報を参照しながら、AIが質問に回答する機能です。参照がある場合とない場合を明確に区別し、ハルシネーションを防止する設計となっています。また、関連投稿やおすすめユーザーを表示することで、コミュニティ内のつながりを促進します。

